# PBL Learning 平台 - 完整设置指南

## 📋 当前状态

✅ **已完成：**
- Supabase 已部署在服务器 (10.1.20.75)
- 应用配置已更新指向自部署的 Supabase
- API 代码已简化，移除了对不存在表的依赖
- 创建了最小化数据库脚本

⏳ **待完成：**
- 在 Supabase 数据库中创建 `projects` 表

## 🎯 快速设置（3 种方法）

### 方法 1: 使用 Supabase Studio（最简单，推荐）

1. **打开 Supabase Studio**
   ```
   http://10.1.20.75:4000
   ```

2. **登录**
   - 用户名: `supabase`
   - 密码: `supabase-dashboard-2025`

3. **进入 SQL Editor**
   - 点击左侧菜单的 "SQL Editor"
   - 点击 "New Query"

4. **执行 SQL 脚本**
   - 打开项目中的 `supabase-minimal-setup.sql` 文件
   - 复制全部内容
   - 粘贴到 SQL 编辑器
   - 点击 "Run" 或按 Cmd+Enter

5. **验证成功**
   - 在 SQL 编辑器中运行：
     ```sql
     SELECT * FROM projects LIMIT 1;
     ```
   - 如果没有报错，说明表创建成功！

### 方法 2: 使用命令行（需要 psql）

如果你的电脑上安装了 PostgreSQL 客户端：

```bash
# 安装 psql（如果还没有）
# macOS:
brew install postgresql

# Ubuntu/Debian:
sudo apt-get install postgresql-client

# 运行设置脚本
./setup-database.sh
```

### 方法 3: 使用 Docker（需要 Docker）

如果你的电脑上安装了 Docker：

```bash
# 确保 Docker Desktop 正在运行
# 然后运行：
./setup-database-docker.sh
```

## 📊 数据库配置信息

### Supabase 连接信息
- **API URL**: `http://10.1.20.75:8000`
- **Anon Key**: 已配置在 `.env.local`
- **Service Role Key**: 已配置在 `.env.local`

### 数据库直连信息
- **主机**: `10.1.20.75`
- **端口**: `5432`
- **数据库**: `postgres`
- **用户**: `postgres`
- **密码**: `your-super-secret-password-change-this`

## 🗄️ 数据库表结构

### projects 表（最小化版本）

```sql
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    title VARCHAR(255) NOT NULL,
    description TEXT,
    created_by UUID NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**功能：**
- ✅ 用户可以创建项目
- ✅ 用户可以查看自己的项目
- ✅ 用户可以编辑和删除自己的项目
- ✅ 行级安全（RLS）已启用
- ✅ 自动更新时间戳

**限制：**
- ❌ 暂时没有 6 阶段功能
- ❌ 暂时没有测试系统
- ❌ 暂时没有协作功能

## 🚀 测试应用

设置完数据库后：

1. **刷新浏览器**
   ```
   http://localhost:3002
   ```

2. **注册新账户**
   - 点击 "Sign Up"
   - 输入邮箱和密码
   - 注册成功后会自动登录

3. **创建项目**
   - 点击 "Create New Project"
   - 输入项目标题和描述
   - 点击 "Create"

4. **验证成功**
   - 如果能看到项目列表，说明一切正常！
   - 如果还有错误，查看下面的故障排除部分

## 🐛 故障排除

### 问题 1: 无法连接到 Supabase Studio

**症状：** 访问 http://10.1.20.75:4000 无法打开

**解决方案：**
1. 检查 Supabase 服务是否运行：
   ```bash
   ssh root@10.1.20.75
   cd /root/supabase/docker
   docker compose ps
   ```

2. 如果服务未运行，启动它：
   ```bash
   docker compose up -d
   ```

### 问题 2: SQL 执行失败

**症状：** 在 SQL Editor 中运行脚本时出错

**可能原因和解决方案：**

1. **权限不足**
   - 确保使用管理员账户登录
   - 检查数据库连接字符串是否正确

2. **表已存在**
   - 如果看到 "relation already exists" 错误，说明表已经创建
   - 可以忽略这个错误，或者先删除表：
     ```sql
     DROP TABLE IF EXISTS projects CASCADE;
     ```

3. **RLS 策略冲突**
   - 脚本会自动删除旧策略，但如果还有问题：
     ```sql
     DROP POLICY IF EXISTS "Users can view own projects" ON projects;
     DROP POLICY IF EXISTS "Users can create projects" ON projects;
     DROP POLICY IF EXISTS "Users can update own projects" ON projects;
     DROP POLICY IF EXISTS "Users can delete own projects" ON projects;
     ```

### 问题 3: 创建项目时返回 401 错误

**症状：** 点击创建项目后返回 "Unauthorized"

**解决方案：**
1. 确保已登录
2. 检查浏览器控制台的错误信息
3. 验证 RLS 策略是否正确设置：
   ```sql
   SELECT * FROM pg_policies WHERE tablename = 'projects';
   ```

### 问题 4: 创建项目时返回 500 错误

**症状：** 服务器内部错误

**解决方案：**
1. 检查 Next.js 开发服务器的日志
2. 确保 `.env.local` 配置正确
3. 验证数据库连接：
   ```bash
   curl http://10.1.20.75:8000/rest/v1/projects \
     -H "apikey: YOUR_ANON_KEY"
   ```

## 📁 项目文件说明

### 数据库脚本
- **supabase-minimal-setup.sql** - 最小化数据库脚本（推荐）
- **supabase-setup.sql** - 完整数据库脚本（包含所有功能）

### 设置脚本
- **setup-database.sh** - 使用 psql 设置数据库
- **setup-database-docker.sh** - 使用 Docker 设置数据库
- **setup-database-api.sh** - 显示设置说明

### 配置文件
- **.env.local** - 本地环境变量（已配置）
- **.env.example** - 环境变量示例

### 文档
- **QUICK_START.md** - 快速启动指南
- **DATABASE_SETUP.md** - 数据库设置详细说明
- **完整设置指南.md** - 本文件

## 🔄 升级到完整功能

如果你想要完整的 6 阶段 PBL 系统：

1. **确认最小化版本工作正常**
   - 能够创建和查看项目

2. **运行完整脚本**
   - 在 Supabase Studio 中运行 `supabase-setup.sql`
   - 这会添加所有高级功能

3. **更新 API 代码**
   - 恢复 `app/api/projects/route.ts` 中被注释的代码
   - 添加对新表的支持

## ✅ 验证清单

完成设置后，检查以下项目：

- [ ] Supabase Studio 可以访问 (http://10.1.20.75:4000)
- [ ] 可以登录 Supabase Studio
- [ ] `projects` 表已创建
- [ ] RLS 策略已启用
- [ ] 应用可以访问 (http://localhost:3002)
- [ ] 可以注册新用户
- [ ] 可以登录
- [ ] 可以创建项目
- [ ] 可以查看项目列表
- [ ] 可以编辑项目
- [ ] 可以删除项目

## 🎉 下一步

设置完成后，你可以：

1. **测试所有功能**
   - 创建多个项目
   - 测试编辑和删除
   - 验证权限控制

2. **部署到生产环境**
   - 更新生产环境的环境变量
   - 在生产数据库中运行相同的 SQL 脚本

3. **添加更多功能**
   - 运行完整的 `supabase-setup.sql`
   - 实现 6 阶段 PBL 系统
   - 添加协作功能

## 📞 需要帮助？

如果遇到问题：

1. 检查本指南的故障排除部分
2. 查看 Next.js 开发服务器的日志
3. 查看 Supabase 服务器的日志：
   ```bash
   ssh root@10.1.20.75
   cd /root/supabase/docker
   docker compose logs -f
   ```

---

**当前版本：** 最小化设置
**最后更新：** 2026-01-13
**状态：** 等待数据库设置
