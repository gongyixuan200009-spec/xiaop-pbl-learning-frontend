# CSV导出功能说明

## 功能概述

系统现在支持两种CSV导出方式，满足不同的数据分析需求：

### 1. 导出用户状态CSV（原有功能）
**端点**: `GET /api/admin/export-users`
**文件名**: `users_export_YYYYMMDD_HHMMSS.csv`

**包含内容**:
- 用户基本信息（用户名、年级、性别、数学成绩、理科感受、年龄、学校）
- 当前阶段和已完成阶段
- 每个阶段的提取字段数据
- 测试状态（未开始/进行中/已通过）
- 测试凭证
- 测试对话（格式化为可读文本）

**适用场景**:
- 查看所有用户的学习进度
- 分析用户填写的字段内容
- 导出结构化的学习数据
- 生成学习报告

**CSV格式示例**:
```csv
用户名,年级,性别,数学成绩,理科感受,当前阶段,已完成阶段,阶段1_工程问题,阶段1_成功标准,阶段1_测试状态,阶段1_测试凭证
张三,四年级,男,A,喜欢,2,1,如何让牛肉变软,成本降低20%,已通过,🎉恭喜通过！
```

### 2. 导出聊天记录CSV（新功能）
**端点**: `GET /api/admin/export-users-chats`
**文件名**: `all_users_chats_YYYYMMDD_HHMMSS.csv`

**包含内容**:
- 所有用户的完整聊天记录
- 包括正常对话和测试对话
- 每条消息包含：用户名、阶段、角色（学生/AI）、内容

**适用场景**:
- 分析对话质量
- 训练AI模型
- 研究学生回答模式
- 导出原始对话数据用于深度分析

**CSV格式示例**:
```csv
用户名,阶段,角色,内容
张三,阶段1,AI,嗨 张三！我是工小助，你的AI学习伙伴！
张三,阶段1,学生,我想让牛肉变得更好吃
张三,阶段1,AI,好的！那我们把这个困扰变成一个工程问题。
张三,阶段1_测试,学生,我准备好了
张三,阶段1_测试,AI,请说出你的工程问题陈述
```

## 前端使用

在管理后台的"用户列表"页面，顶部有两个导出按钮：

1. **导出状态** (蓝色按钮) - 导出用户状态CSV
2. **导出聊天** (绿色按钮) - 导出聊天记录CSV

每个用户卡片上也有"导出该用户数据"按钮，可以单独导出某个用户的聊天记录。

## 技术实现

### 后端实现
- 文件: `backend/routers/admin.py`
- 新增端点: `@router.get("/export-users-chats")`
- 支持新旧数据格式（有/无项目管理）
- 自动添加UTF-8 BOM以支持Excel正确显示中文
- 错误处理：跳过损坏的用户文件

### 前端实现
- 文件: `frontend/src/app/admin/page.tsx`
- 新增"导出聊天"按钮
- 使用`window.open()`直接下载CSV文件
- 添加tooltip说明按钮功能

## 数据格式

### 状态CSV列
- 固定列：用户名、年级、性别、数学成绩、理科感受、年龄、学校、当前阶段、已完成阶段
- 动态列：阶段{N}_{字段名}、阶段{N}_测试状态、阶段{N}_测试凭证、阶段{N}_测试对话

### 聊天CSV列
- 用户名：学生用户名
- 阶段：阶段1、阶段2、阶段1_测试等
- 角色：学生或AI
- 内容：消息文本内容

## 注意事项

1. **编码**: 所有CSV文件使用UTF-8编码，并添加BOM以确保Excel正确显示中文
2. **文件名**: 包含时间戳，避免覆盖
3. **数据完整性**: 自动跳过损坏的用户数据文件
4. **性能**: 大量用户时可能需要较长时间生成CSV
5. **隐私**: 导出的CSV包含完整对话内容，请妥善保管

## 部署状态

✅ 后端端点已部署
✅ 前端界面已更新
✅ 服务已重启
✅ 功能测试通过

## 测试结果

```bash
# 测试新端点
curl http://localhost:8000/api/admin/export-users-chats

# 输出示例
用户名,阶段,角色,内容
1111,阶段1,AI,"嗨 1111！我是小P，你的AI学习伙伴！"
1111,阶段1,学生,我想让牛肉变得更好吃，现在太硬了
...
```

## 未来改进建议

1. 添加日期范围筛选
2. 支持按阶段筛选导出
3. 添加导出进度提示
4. 支持ZIP打包下载
5. 添加导出历史记录
